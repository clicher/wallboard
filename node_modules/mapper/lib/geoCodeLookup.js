var async = require('async');
var request = require('request');

module.exports = function(data, config, callback) {
  geocodeApiCall(data, function(err, d) {
    callback(null, data);
  });
};

function geocodeApiCall(data, callback) {

  async.mapSeries(data, function(location, cb) {
    var loc = location['location'].replace(' ', '+');
    locationToLonLat(location, loc, function(err, d) {
      cb(null, d);
    });
  }, function(err, d) {
    console.log(d.length);
    callback(null, d);
  });
};

function locationToLonLat(obj, loc, callback) {

  request('https://maps.googleapis.com/maps/api/geocode/json?address=' + loc +
      '&key=AIzaSyB2h6QaWv0cEVV0AScxffuMDKhaVqpUx7A',
      function(error, response, html) {
        if (error || response.statusCode != 200) {
          console.log('Error in HTTP call or Status code not 200');
          callback(null, 'ERROR');
        } else {
          var json = JSON.parse(html).results[0].geometry.location || 'FAILED';
          if (json == 'FAILED') {
            callback(null, 'FAILED');
          } else {
            obj['cord'] = json;
            callback(null, obj);
          }
        }
      });
};
