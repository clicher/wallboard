var request = require('request');
var _ = require('underscore');
var c;

module.exports = function(config, callback) {
  c = config;

  httpRequest(function(err, d) {
    rejectTag(d, function(err, da) {
      filterGroup(da, function(err, dat) {
        cleanData(dat, function(err, data) {
          callback(null, data);
        });
      });
    });
  });
};

function httpRequest(callback) {
  request(
      {
        method: c.phoneSystemInformation.method,
        //proxy: "http://127.0.0.1:8888",
        uri: c.phoneSystemInformation.protocol + c.phoneSystemInformation.host +
            c.queue.uri,
        headers: {
          'Authorization': 'Basic ' + new Buffer(
              c.phoneSystemInformation.phoneSystemUsername + ':' +
              c.phoneSystemInformation.phoneSystemGetToken).toString('base64'),
        },
      }, function(error, response, html) {
        if (error || response.statusCode != 200) {
          callback(null, 'ERROR');
        } else {
          var queues = JSON.parse(html)['queue'] || 'FAILED';
          if (queues == 'FAILED') {
            callback(null, 'FAILED');
          } else {
            callback(null, queues);
          }
        }
        ;
      });
};

function rejectTag(data, callback) {
  callback(null, _.reject(data, {'media-type': 'vmail'}));
};

function filterGroup(data, callback) {
  callback(null, _.filter(data, function(que) {
    return c.queue.rejectedVendors.indexOf(que['queue-name']) !== -1;
  }));
};

function cleanData(data, callback) {
  for (var i = 0; i < data.length; i++) {
    var json = {};
    for (var j = 0; j < c.queue.returnedFields.length; j++) {
      json[c.queue.returnedFields[j]] = data[i][c.queue.returnedFields[j]];
    }
    data[i] = json;
  }
  ;
  callback(null, data);
};
